# ç³»ç»Ÿæ¶æ„æ–‡æ¡£

## 1. æ•´ä½“æ¶æ„

### 1.1 ä¸‰å±‚æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Layer 1: ç”¨æˆ·ç•Œé¢å±‚                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ä»»åŠ¡çœ‹æ¿    â”‚  â”‚  ä»»åŠ¡è¯¦æƒ…    â”‚  â”‚  Agent ç›‘æ§      â”‚  â”‚
â”‚  â”‚  (List View) â”‚  â”‚  (Detail)    â”‚  â”‚  (Dashboard)     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚                 â”‚                   â”‚             â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                           â”‚                                 â”‚
â”‚                   HTTP/WebSocket API                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Layer 2: ä¸šåŠ¡é€»è¾‘å±‚                        â”‚
â”‚                   (Orchestrator åç«¯)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                  æ ¸å¿ƒæ¨¡å—                               â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚ä»»åŠ¡è°ƒåº¦ â”‚  â”‚çŠ¶æ€ç®¡ç† â”‚  â”‚äº‹ä»¶èšåˆ â”‚  â”‚äº§ç‰©è·Ÿè¸ª â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                           â”‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                  æ•°æ®è®¿é—®å±‚                           â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚Issue DAOâ”‚  â”‚Run DAO  â”‚  â”‚Agent DAOâ”‚  â”‚Event DAOâ”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                           â”‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                  å¤–éƒ¨é›†æˆå±‚                           â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚  â”‚ GitLab API  â”‚          â”‚ WebSocket Gateway   â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  Connector  â”‚          â”‚  (Agent Connection) â”‚   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                         â”‚
            â”‚ GitLab                  â”‚ WebSocket
            â”‚ Webhooks                â”‚ (bidirectional)
            â”‚                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  External Service   â”‚    â”‚   Layer 3: Agent æ‰§è¡Œå±‚          â”‚
â”‚  (GitLab Server)    â”‚    â”‚   (ACP Proxy - æœ¬åœ°éƒ¨ç½²)         â”‚
â”‚                     â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  - Merge Requests   â”‚    â”‚  â”‚  åè®®è½¬æ¢å¼•æ“              â”‚  â”‚
â”‚  - CI Pipelines     â”‚    â”‚  â”‚  (WebSocket â†” stdio)      â”‚  â”‚
â”‚  - Webhooks         â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚          â”‚ stdio (JSON-RPC)     â”‚
                           â”‚          â”‚                       â”‚
                           â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
                           â”‚  â”‚  Agent è¿›ç¨‹ç®¡ç†å™¨          â”‚  â”‚
                           â”‚  â”‚  (Process Manager)        â”‚  â”‚
                           â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                           â”‚          â”‚ subprocess           â”‚
                           â”‚          â†“                       â”‚
                           â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
                           â”‚  â”‚  Codex CLI Agent          â”‚  â”‚
                           â”‚  â”‚  (å­è¿›ç¨‹è¿è¡Œ)             â”‚  â”‚
                           â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æ•°æ®æµå›¾

#### æµç¨‹ 1: åˆ›å»ºä»»åŠ¡åˆ°æ‰§è¡Œ

```
[ç”¨æˆ·]
   â”‚
   â”‚ 1. POST /api/issues
   â†“
[Web UI]
   â”‚
   â”‚ 2. HTTP Request
   â†“
[Orchestrator]
   â”‚
   â”‚ 3. Save to DB
   â†“
[PostgreSQL]
   â”‚
   â”‚ 4. Create Run
   â†“
[Orchestrator - Scheduler]
   â”‚
   â”‚ 5. Select Agent (first online)
   â†“
[Orchestrator - WebSocket Gateway]
   â”‚
   â”‚ 6. Send Task Message
   â”‚    {type: "execute_task", run_id: "...", prompt: "..."}
   â†“
[ACP Proxy] (via WebSocket)
   â”‚
   â”‚ 7. Convert to JSON-RPC
   â†“
[Codex CLI] (via stdin)
   â”‚
   â”‚ 8. Process and Execute
   â†“
[Codex outputs to stdout]
   â”‚
   â”‚ 9. Parse JSON-RPC Response
   â†“
[ACP Proxy]
   â”‚
   â”‚ 10. Send to Orchestrator
   â”‚     {type: "agent_update", run_id: "...", content: "..."}
   â†“
[Orchestrator - WebSocket Gateway]
   â”‚
   â”‚ 11. Save Event
   â†“
[PostgreSQL]
   â”‚
   â”‚ 12. Push to Web UI
   â†“
[Web UI] (via WebSocket)
   â”‚
   â”‚ 13. Update Timeline
   â†“
[ç”¨æˆ·çœ‹åˆ°å®æ—¶è¿›åº¦]
```

#### æµç¨‹ 2: Agent åˆ›å»º PR

```
[Codex CLI]
   â”‚
   â”‚ 1. git push origin branch
   â†“
[GitLab Server]
   â”‚
   â”‚ 2. Codex outputs: "Branch created: xxx"
   â†“
[ACP Proxy] (parse stdout)
   â”‚
   â”‚ 3. Send to Orchestrator
   â”‚    {type: "branch_created", branch: "..."}
   â†“
[Orchestrator]
   â”‚
   â”‚ 4. Call GitLab API
   â”‚    POST /projects/:id/merge_requests
   â†“
[GitLab Server]
   â”‚
   â”‚ 5. PR Created
   â†“
[Orchestrator]
   â”‚
   â”‚ 6. Save Artifact (type: 'pr')
   â”‚ 7. Create Event (type: 'git.pr.created')
   â”‚ 8. Update Run status â†’ 'waiting_ci'
   â†“
[PostgreSQL]
   â”‚
   â”‚ 9. Push to Web UI
   â†“
[Web UI]
   â”‚
   â”‚ 10. Display PR Link
   â†“
[ç”¨æˆ·ç‚¹å‡»è·³è½¬åˆ° GitLab]
```

#### æµç¨‹ 3: CI ç»“æœå›å†™

```
[GitLab CI]
   â”‚
   â”‚ 1. Pipeline Started
   â†“
[GitLab Webhook]
   â”‚
   â”‚ 2. POST /webhooks/gitlab
   â”‚    {event: "pipeline", status: "running", ...}
   â†“
[Orchestrator - Webhook Handler]
   â”‚
   â”‚ 3. Validate Secret Token
   â”‚ 4. Parse Event
   â†“
[Orchestrator]
   â”‚
   â”‚ 5. Create Event (type: 'ci.check.started')
   â†“
[PostgreSQL]
   â”‚
   â”‚ ... CI è¿è¡Œ ...
   â”‚
[GitLab CI]
   â”‚
   â”‚ 6. Pipeline Success/Failure
   â†“
[GitLab Webhook]
   â”‚
   â”‚ 7. POST /webhooks/gitlab
   â”‚    {event: "pipeline", status: "success", ...}
   â†“
[Orchestrator - Webhook Handler]
   â”‚
   â”‚ 8. Update Run status
   â”‚ 9. Create Event (type: 'ci.check.passed')
   â†“
[PostgreSQL]
   â”‚
   â”‚ 10. Push to Web UI
   â†“
[Web UI]
   â”‚
   â”‚ 11. Show Green Check âœ…
   â†“
[ç”¨æˆ·å¯ä»¥åˆå¹¶ PR]
```

---

## 2. æ ¸å¿ƒç»„ä»¶è¯¦è§£

### 2.1 Orchestrator (åç«¯)

#### èŒè´£

1. **ä»»åŠ¡ç®¡ç†**: Issue CRUDã€Run ç”Ÿå‘½å‘¨æœŸç®¡ç†
2. **è°ƒåº¦å¼•æ“**: é€‰æ‹©åˆé€‚çš„ Agent æ‰§è¡Œä»»åŠ¡
3. **çŠ¶æ€ç®¡ç†**: ç»´æŠ¤ Run çš„çŠ¶æ€æœº
4. **äº‹ä»¶èšåˆ**: æ”¶é›†å¹¶å­˜å‚¨æ¥è‡ª Agentã€GitLabã€CI çš„äº‹ä»¶
5. **API æœåŠ¡**: å¯¹å¤–æä¾› RESTful API å’Œ WebSocket æ¥å£
6. **GitLab é›†æˆ**: è°ƒç”¨ GitLab APIã€æ¥æ”¶ Webhook

#### å…³é”®æ¨¡å—

##### æ¨¡å— 1: API Layer

```
è·¯ç”±å®šä¹‰:
  POST   /api/issues          - åˆ›å»ºä»»åŠ¡
  GET    /api/issues          - åˆ—è¡¨
  GET    /api/issues/:id      - è¯¦æƒ…
  PATCH  /api/issues/:id      - æ›´æ–°
  DELETE /api/issues/:id      - åˆ é™¤

  POST   /api/runs            - åˆ›å»ºæ‰§è¡Œå®ä¾‹
  GET    /api/runs/:id        - æŸ¥è¯¢çŠ¶æ€
  GET    /api/runs/:id/events - è·å–äº‹ä»¶æ—¶é—´çº¿
  POST   /api/runs/:id/cancel - å–æ¶ˆæ‰§è¡Œ

  POST   /api/agents/register - Agent æ³¨å†Œ
  GET    /api/agents          - åˆ—è¡¨
  POST   /api/agents/:id/heartbeat - å¿ƒè·³

  POST   /webhooks/gitlab     - GitLab Webhook å…¥å£

  WebSocket:
    /ws/agent     - Agent è¿æ¥
    /ws/client    - Web UI è¿æ¥
```

##### æ¨¡å— 2: Scheduler (è°ƒåº¦å™¨)

```
æ ¸å¿ƒé€»è¾‘:
  1. ç›‘å¬ Issue åˆ›å»ºäº‹ä»¶
  2. åˆ›å»º Run è®°å½•
  3. é€‰æ‹© Agent:
     - è·å–æ‰€æœ‰åœ¨çº¿ Agent
     - è¿‡æ»¤æ‰è´Ÿè½½å·²æ»¡çš„
     - é€‰æ‹©ç¬¬ä¸€ä¸ªï¼ˆMVP ç®€å•ç­–ç•¥ï¼‰
  4. é€šè¿‡ WebSocket å‘é€ä»»åŠ¡
  5. æ›´æ–° Run çŠ¶æ€ â†’ 'pending'

ä¼ªä»£ç :
  async function scheduleTask(issue_id) {
    const issue = await Issue.findById(issue_id);
    const run = await Run.create({
      issue_id: issue.id,
      status: 'pending'
    });

    const agents = await Agent.findAllOnline();
    const availableAgents = agents.filter(a => a.current_load < a.max_concurrent);

    if (availableAgents.length === 0) {
      throw new Error("No available agent");
    }

    const selectedAgent = availableAgents[0];

    await sendTaskToAgent(selectedAgent.id, {
      run_id: run.id,
      prompt: generatePrompt(issue)
    });

    await run.update({ agent_id: selectedAgent.id, status: 'running' });
  }
```

##### æ¨¡å— 3: State Machine (çŠ¶æ€æœº)

```
Run çŠ¶æ€å®šä¹‰:
  - pending         (å·²åˆ›å»ºï¼Œç­‰å¾… Agent)
  - running         (Agent æ­£åœ¨æ‰§è¡Œ)
  - waiting_ci      (ç­‰å¾… CI æ£€æŸ¥)
  - completed       (æˆåŠŸå®Œæˆ)
  - failed          (æ‰§è¡Œå¤±è´¥)
  - cancelled       (ç”¨æˆ·å–æ¶ˆ)

çŠ¶æ€è½¬æ¢è§„åˆ™:
  pending â†’ running         (Agent å¼€å§‹æ‰§è¡Œ)
  running â†’ waiting_ci      (PR å·²åˆ›å»º)
  waiting_ci â†’ completed    (CI é€šè¿‡ + ç”¨æˆ·åˆå¹¶ PR)
  running â†’ failed          (Agent æŠ¥é”™ or è¶…æ—¶)
  * â†’ cancelled             (ç”¨æˆ·ä¸»åŠ¨å–æ¶ˆ)

äº‹ä»¶è§¦å‘çŠ¶æ€å˜æ›´:
  - agent_started        â†’ pending â†’ running
  - pr_created           â†’ running â†’ waiting_ci
  - ci_passed            â†’ (ä¸æ”¹å˜çŠ¶æ€ï¼Œåªè®°å½•)
  - pr_merged            â†’ waiting_ci â†’ completed
  - agent_error          â†’ running â†’ failed
  - timeout              â†’ running â†’ failed
```

##### æ¨¡å— 4: Event Aggregator (äº‹ä»¶èšåˆå™¨)

```
äº‹ä»¶æ¥æº:
  1. Agent (via WebSocket)
  2. GitLab (via Webhook)
  3. System (å†…éƒ¨è§¦å‘)

äº‹ä»¶å­˜å‚¨:
  æ¯ä¸ªäº‹ä»¶å­˜å‚¨ä¸º Event è®°å½•:
    - run_id
    - timestamp
    - source (acp / gitlab / system)
    - type (è§åæ–‡æšä¸¾)
    - payload (JSON)

æŸ¥è¯¢ä¼˜åŒ–:
  - ç´¢å¼•: (run_id, timestamp)
  - åˆ†é¡µ: æ¯é¡µ 50 æ¡
  - å®æ—¶æ¨é€: é€šè¿‡ WebSocket æ¨é€ç»™ Web UI
```

##### æ¨¡å— 5: GitLab Connector

```
åŠŸèƒ½:
  1. API è°ƒç”¨:
     - åˆ›å»º PR
     - æŸ¥è¯¢ PR çŠ¶æ€
     - æŸ¥è¯¢ CI Pipeline

  2. Webhook å¤„ç†:
     - éªŒè¯ Secret Token
     - è§£æäº‹ä»¶ç±»å‹
     - è§¦å‘çŠ¶æ€å˜æ›´

é…ç½®:
  - gitlab_url: "https://gitlab.example.com"
  - access_token: "glpat-xxxxxxxxxxxx"
  - webhook_secret: "random-secret-string"

å…³é”® API è°ƒç”¨:
  åˆ›å»º PRï¼ˆGitLab Merge Requestï¼‰:
    POST /api/v4/projects/:project_id/merge_requests
    Body: {
      source_branch: "acp/issue-123/run-456",
      target_branch: "main",
      title: "[ACP] Fix user login bug",
      description: "Issue #123\n\néªŒæ”¶æ ‡å‡†:\n- ...",
      remove_source_branch: true
    }

  æŸ¥è¯¢ Pipeline:
    GET /api/v4/projects/:project_id/pipelines/:pipeline_id
    Response: {
      id: 12345,
      status: "success" | "failed" | "running",
      ...
    }
```

---

### 2.2 ACP Proxy (æœ¬åœ°ä»£ç†)

#### èŒè´£

1. **è¿æ¥ç®¡ç†**: ç»´æŠ¤ä¸ Orchestrator çš„ WebSocket é•¿è¿æ¥
2. **åè®®è½¬æ¢**: WebSocket æ¶ˆæ¯ â†” JSON-RPC over stdio
3. **è¿›ç¨‹ç®¡ç†**: å¯åŠ¨/åœæ­¢/é‡å¯ Codex CLI å­è¿›ç¨‹
4. **å¿ƒè·³ä¿æ´»**: å®šæœŸå‘é€å¿ƒè·³ï¼ŒæŠ¥å‘Šåœ¨çº¿çŠ¶æ€
5. **æ—¥å¿—è®°å½•**: æœ¬åœ°è®°å½•æ‰€æœ‰äº¤äº’æ—¥å¿—

#### å…³é”®æ¨¡å—

##### æ¨¡å— 1: WebSocket Client

```
è¿æ¥æµç¨‹:
  1. å¯åŠ¨æ—¶è‡ªåŠ¨è¿æ¥åˆ° Orchestrator
  2. å‘é€æ³¨å†Œæ¶ˆæ¯:
     {
       "type": "register_agent",
       "agent_id": "codex-local-1",
       "capabilities": ["javascript", "python"],
       "max_concurrent": 2
     }
  3. æ¥æ”¶ç¡®è®¤:
     {
       "type": "register_ack",
       "success": true
     }

é‡è¿ç­–ç•¥:
  - è¿æ¥æ–­å¼€åï¼Œä½¿ç”¨æŒ‡æ•°é€€é¿é‡è¿
  - å»¶è¿Ÿ: 5s â†’ 10s â†’ 20s â†’ 40s (æœ€å¤§ 60s)
  - æœ€å¤šé‡è¯•: æ— é™æ¬¡ï¼ˆé™¤éç”¨æˆ·ä¸»åŠ¨åœæ­¢ï¼‰

å¿ƒè·³:
  - æ¯ 30 ç§’å‘é€ä¸€æ¬¡:
    {
      "type": "heartbeat",
      "agent_id": "codex-local-1",
      "current_load": 1,
      "uptime": 3600
    }
```

##### æ¨¡å— 2: Protocol Bridge (åè®®æ¡¥æ¥)

```
WebSocket â†’ JSON-RPC:
  è¾“å…¥ (from Orchestrator):
    {
      "type": "execute_task",
      "run_id": "run-123",
      "session_id": "sess-abc",
      "prompt": "Implement user login feature"
    }

  è½¬æ¢ä¸º (å†™å…¥ Codex stdin):
    {
      "jsonrpc": "2.0",
      "id": 1,
      "method": "session/prompt",
      "params": {
        "sessionId": "sess-abc",
        "prompt": [
          {
            "type": "text",
            "text": "Implement user login feature"
          }
        ]
      }
    }

JSON-RPC â†’ WebSocket:
  è¾“å…¥ (from Codex stdout):
    {
      "jsonrpc": "2.0",
      "method": "session/update",
      "params": {
        "sessionId": "sess-abc",
        "update": {
          "type": "agentMessage",
          "content": [
            {
              "type": "text",
              "text": "I'm analyzing the auth module..."
            }
          ]
        }
      }
    }

  è½¬æ¢ä¸º (å‘é€åˆ° Orchestrator):
    {
      "type": "agent_update",
      "run_id": "run-123",
      "content": {
        "text": "I'm analyzing the auth module...",
        "timestamp": "2026-01-25T10:30:00Z"
      }
    }
```

##### æ¨¡å— 3: Process Manager (è¿›ç¨‹ç®¡ç†å™¨)

```
å¯åŠ¨ Codex:
  cmd := exec.Command("codex", "--acp")

  stdin, _ := cmd.StdinPipe()
  stdout, _ := cmd.StdoutPipe()
  stderr, _ := cmd.StderrPipe()

  cmd.Start()

ç›‘å¬è¾“å‡º:
  - åˆ›å»º goroutine è¯»å– stdout
  - ä½¿ç”¨ bufio.Scanner æŒ‰è¡Œè¯»å–ï¼ˆJSON-RPC ä»¥æ¢è¡Œç¬¦åˆ†éš”ï¼‰
  - è§£æä¸º JSON å¯¹è±¡
  - è½¬å‘åˆ° Orchestrator

é”™è¯¯å¤„ç†:
  - å¦‚æœ Codex è¿›ç¨‹æ„å¤–é€€å‡ºï¼ˆexit code != 0ï¼‰
    â†’ è®°å½•é”™è¯¯æ—¥å¿—
    â†’ é€šçŸ¥ Orchestrator (agent_error)

  - å¦‚æœ Codex 15 åˆ†é’Ÿæ— è¾“å‡º
    â†’ å‘é€ SIGTERM (cmd.Process.Signal(syscall.SIGTERM))
    â†’ ç­‰å¾… 5 ç§’
    â†’ ä»æœªé€€å‡ºåˆ™ SIGKILL (cmd.Process.Kill())
    â†’ é€šçŸ¥ Orchestrator (timeout)
```

---

### 2.3 Web UI (å‰ç«¯)

#### æŠ€æœ¯æ ˆ

- React 18 + TypeScript
- Ant Design 5ï¼ˆç»„ä»¶åº“ï¼‰
- Axiosï¼ˆHTTP å®¢æˆ·ç«¯ï¼‰
- Socket.io-clientï¼ˆWebSocketï¼‰
- React Routerï¼ˆè·¯ç”±ï¼‰

#### é¡µé¢ç»“æ„

##### é¡µé¢ 1: ä»»åŠ¡åˆ—è¡¨ (`/issues`)

```
å¸ƒå±€:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Header: Logo + "åˆ›å»ºä»»åŠ¡" æŒ‰é’®        â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚  Table:                                â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
  â”‚  â”‚ ID   â”‚ æ ‡é¢˜     â”‚ çŠ¶æ€   â”‚ Agent  â”‚ â”‚
  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
  â”‚  â”‚ #123 â”‚ ç™»å½•åŠŸèƒ½ â”‚ è¿è¡Œä¸­ â”‚ codex-1â”‚ â”‚
  â”‚  â”‚ #122 â”‚ æ–‡æ¡£ä¿®å¤ â”‚ å®Œæˆ   â”‚ codex-1â”‚ â”‚
  â”‚  â”‚ ...  â”‚ ...      â”‚ ...    â”‚ ...    â”‚ â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

äº¤äº’:
  - ç‚¹å‡»è¡Œ â†’ è·³è½¬åˆ°è¯¦æƒ…é¡µ
  - ç‚¹å‡»"åˆ›å»ºä»»åŠ¡" â†’ å¼¹å‡ºè¡¨å• Modal
```

##### é¡µé¢ 2: ä»»åŠ¡è¯¦æƒ… (`/issues/:id`)

```
å¸ƒå±€:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Header: è¿”å› | #123 ç™»å½•åŠŸèƒ½ | [è¿è¡Œä¸­]â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚  Left Panel (60%):                     â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  ä»»åŠ¡æè¿°                         â”‚  â”‚
  â”‚  â”‚  éªŒæ”¶æ ‡å‡†: 1. ... 2. ...         â”‚  â”‚
  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
  â”‚  â”‚  æ—¶é—´çº¿ (å®æ—¶æ»šåŠ¨):              â”‚  â”‚
  â”‚  â”‚  10:30 Agent å¼€å§‹æ‰§è¡Œ             â”‚  â”‚
  â”‚  â”‚  10:31 æ­£åœ¨åˆ†æä»£ç ...            â”‚  â”‚
  â”‚  â”‚  10:32 åˆ›å»ºåˆ†æ”¯: acp/123/run-456 â”‚  â”‚
  â”‚  â”‚  10:35 PR å·²åˆ›å»º: !456           â”‚  â”‚
  â”‚  â”‚  10:40 CI è¿è¡Œä¸­...               â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                        â”‚
  â”‚  Right Panel (40%):                    â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  äº§ç‰©:                            â”‚  â”‚
  â”‚  â”‚  - PR: !456 [æŸ¥çœ‹] âœ…             â”‚  â”‚
  â”‚  â”‚  - åˆ†æ”¯: acp/123/run-456         â”‚  â”‚
  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
  â”‚  â”‚  Agent ä¿¡æ¯:                      â”‚  â”‚
  â”‚  â”‚  - ID: codex-local-1             â”‚  â”‚
  â”‚  â”‚  - çŠ¶æ€: åœ¨çº¿                     â”‚  â”‚
  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
  â”‚  â”‚  æ“ä½œ:                            â”‚  â”‚
  â”‚  â”‚  [å–æ¶ˆä»»åŠ¡] [æŸ¥çœ‹æ—¥å¿—]           â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å®æ—¶æ›´æ–°:
  - è¿æ¥ WebSocket: /ws/client?run_id=run-456
  - æ”¶åˆ°æ¶ˆæ¯åè¿½åŠ åˆ°æ—¶é—´çº¿
  - è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
```

##### é¡µé¢ 3: Agent ç›‘æ§ (`/agents`)

```
å¸ƒå±€:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Header: Agent ç›‘æ§                    â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚  Cards Grid:                           â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
  â”‚  â”‚ codex-local-1 â”‚  â”‚ codex-local-2 â”‚ â”‚
  â”‚  â”‚ ğŸŸ¢ åœ¨çº¿       â”‚  â”‚ ğŸ”´ ç¦»çº¿       â”‚ â”‚
  â”‚  â”‚ è´Ÿè½½: 1/2     â”‚  â”‚ è´Ÿè½½: 0/2     â”‚ â”‚
  â”‚  â”‚ å½“å‰ä»»åŠ¡:     â”‚  â”‚ ç©ºé—²          â”‚ â”‚
  â”‚  â”‚ - #123 è¿è¡Œä¸­ â”‚  â”‚               â”‚ â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ•°æ®æº:
  - HTTP: GET /api/agents (æ¯ 5 ç§’è½®è¯¢)
  - æˆ– WebSocket: /ws/agents (å®æ—¶æ¨é€)
```

---

## 3. æ•°æ®æ¨¡å‹

### 3.1 æ ¸å¿ƒè¡¨ç»“æ„

#### Table: projects

```sql
CREATE TABLE projects (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(255) NOT NULL,
  repo_url VARCHAR(500) NOT NULL,
  scm_type VARCHAR(20) NOT NULL DEFAULT 'gitlab',
  default_branch VARCHAR(100) NOT NULL DEFAULT 'main',
  gitlab_project_id INTEGER,
  gitlab_access_token TEXT,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

ç´¢å¼•:
  - PRIMARY KEY (id)
  - UNIQUE (gitlab_project_id)
```

#### Table: issues

```sql
CREATE TABLE issues (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  project_id UUID NOT NULL REFERENCES projects(id),
  title VARCHAR(255) NOT NULL,
  description TEXT,
  acceptance_criteria JSONB,  -- Array of strings
  constraints JSONB,          -- Array of strings
  test_requirements TEXT,
  status VARCHAR(50) NOT NULL DEFAULT 'pending',
  assigned_agent_id UUID REFERENCES agents(id),
  created_by VARCHAR(100),
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

ç´¢å¼•:
  - PRIMARY KEY (id)
  - INDEX (project_id, status)
  - INDEX (assigned_agent_id)
```

#### Table: runs

```sql
CREATE TABLE runs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  issue_id UUID NOT NULL REFERENCES issues(id),
  agent_id UUID NOT NULL REFERENCES agents(id),
  acp_session_id VARCHAR(100),
  workspace_path VARCHAR(500),
  branch_name VARCHAR(200),
  status VARCHAR(50) NOT NULL DEFAULT 'pending',
  started_at TIMESTAMP DEFAULT NOW(),
  completed_at TIMESTAMP,
  failure_reason VARCHAR(100),
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

ç´¢å¼•:
  - PRIMARY KEY (id)
  - INDEX (issue_id)
  - INDEX (agent_id, status)
  - INDEX (acp_session_id)
```

#### Table: agents

```sql
CREATE TABLE agents (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(255) NOT NULL,
  type VARCHAR(20) NOT NULL DEFAULT 'local',
  proxy_id VARCHAR(100),
  capabilities JSONB,
  status VARCHAR(50) NOT NULL DEFAULT 'offline',
  current_load INTEGER NOT NULL DEFAULT 0,
  max_concurrent_runs INTEGER NOT NULL DEFAULT 2,
  last_heartbeat TIMESTAMP,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

ç´¢å¼•:
  - PRIMARY KEY (id)
  - UNIQUE (proxy_id)
  - INDEX (status, current_load)
```

#### Table: events

```sql
CREATE TABLE events (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  run_id UUID NOT NULL REFERENCES runs(id),
  source VARCHAR(50) NOT NULL,  -- 'acp' | 'gitlab' | 'system'
  type VARCHAR(100) NOT NULL,
  payload JSONB,
  metadata JSONB,
  timestamp TIMESTAMP DEFAULT NOW()
);

ç´¢å¼•:
  - PRIMARY KEY (id)
  - INDEX (run_id, timestamp DESC)
  - INDEX (type)
```

#### Table: artifacts

```sql
CREATE TABLE artifacts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  run_id UUID NOT NULL REFERENCES runs(id),
  type VARCHAR(50) NOT NULL,  -- 'branch' | 'pr' | 'patch'
  content JSONB NOT NULL,
  created_at TIMESTAMP DEFAULT NOW()
);

ç´¢å¼•:
  - PRIMARY KEY (id)
  - INDEX (run_id, type)
```

### 3.2 æ•°æ®å…³ç³»å›¾

```
projects (1) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> (N) issues
                                           â”‚
                                           â”‚ (1)
                                           â”‚
                                           â†“
                                         (N) runs
                                           â”‚
                                           â”œâ”€â”€â”€â”€â”€â”€> (N) events
                                           â”‚
                                           â””â”€â”€â”€â”€â”€â”€> (N) artifacts

agents (1) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> (N) runs
```

---

## 4. æŠ€æœ¯é€‰å‹å¯¹æ¯”

### 4.1 åç«¯æ¡†æ¶

| æ¡†æ¶                  | ä¼˜ç‚¹                                    | ç¼ºç‚¹                    | æ¨èåº¦     |
| --------------------- | --------------------------------------- | ----------------------- | ---------- |
| **Node.js + Express** | ç”Ÿæ€ä¸°å¯Œã€å¼‚æ­¥ I/O æ€§èƒ½å¥½ã€ç¤¾åŒºæ´»è·ƒ     | ç±»å‹å®‰å…¨éœ€è¦ TypeScript | â­â­â­â­   |
| **Node.js + Fastify** | æ¯” Express æ›´å¿«ã€å†…ç½® TypeScript æ”¯æŒ   | ç¤¾åŒºè¾ƒå°                | â­â­â­â­â­ |
| **Python + FastAPI**  | å¼€å‘é€Ÿåº¦å¿«ã€è‡ªåŠ¨ç”Ÿæˆ API æ–‡æ¡£ã€ç±»å‹æç¤º | æ€§èƒ½ç•¥é€Šäº Node.js      | â­â­â­â­   |

**æ¨è**: Fastify + TypeScriptï¼ˆæ€§èƒ½ + ç±»å‹å®‰å…¨ï¼‰

### 4.2 ORM

| ORM                     | ä¼˜ç‚¹                               | ç¼ºç‚¹                | æ¨èåº¦     |
| ----------------------- | ---------------------------------- | ------------------- | ---------- |
| **TypeORM**             | æˆç†Ÿã€æ”¯æŒå¤šæ•°æ®åº“ã€è£…é¥°å™¨è¯­æ³•     | é…ç½®å¤æ‚            | â­â­â­â­   |
| **Prisma**              | ç±»å‹å®‰å…¨ã€è‡ªåŠ¨ç”Ÿæˆå®¢æˆ·ç«¯ã€è¿ç§»ç®€å• | ä¸æ”¯æŒæ‰€æœ‰ SQL ç‰¹æ€§ | â­â­â­â­â­ |
| **SQLAlchemy** (Python) | åŠŸèƒ½å¼ºå¤§ã€çµæ´»                     | å­¦ä¹ æ›²çº¿é™¡å³­        | â­â­â­     |

**æ¨è**: Prismaï¼ˆå¼€å‘æ•ˆç‡é«˜ï¼‰

### 4.3 WebSocket åº“

| åº“            | ä¼˜ç‚¹                         | ç¼ºç‚¹                       | æ¨èåº¦     |
| ------------- | ---------------------------- | -------------------------- | ---------- |
| **ws**        | è½»é‡ã€æ€§èƒ½å¥½ã€åŸç”Ÿ WebSocket | åŠŸèƒ½ç®€å•ã€éœ€è¦æ‰‹åŠ¨å¤„ç†é‡è¿ | â­â­â­â­   |
| **Socket.io** | åŠŸèƒ½ä¸°å¯Œã€è‡ªåŠ¨é‡è¿ã€æˆ¿é—´æ”¯æŒ | ä½“ç§¯å¤§ã€åè®®å¤æ‚           | â­â­â­â­â­ |

**æ¨è**: Socket.ioï¼ˆåŠŸèƒ½å®Œå–„ï¼‰

---

## 5. éƒ¨ç½²æ¶æ„

### 5.1 å¼€å‘ç¯å¢ƒ (Docker Compose)

```yaml
version: "3.8"

services:
  # åç«¯ Orchestrator
  backend:
    build: ./backend
    ports:
      - "3000:3000"
    environment:
      - DATABASE_URL=postgresql://user:pass@postgres:5432/acp_system
      - GITLAB_URL=https://gitlab.example.com
      - GITLAB_ACCESS_TOKEN=glpat-xxx
    depends_on:
      - postgres

  # PostgreSQL
  postgres:
    image: postgres:14
    environment:
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=pass
      - POSTGRES_DB=acp_system
    volumes:
      - postgres_data:/var/lib/postgresql/data

  # å‰ç«¯ Web UI
  frontend:
    build: ./frontend
    ports:
      - "8080:80"
    depends_on:
      - backend

volumes:
  postgres_data:
```

### 5.2 ç”Ÿäº§ç¯å¢ƒï¼ˆå•æœº Dockerï¼‰

```
[äº‘æœåŠ¡å™¨ - 1 å°]
  â”œâ”€â”€ Nginx (åå‘ä»£ç†)
  â”‚     â”œâ”€â”€ /api â†’ Backend
  â”‚     â”œâ”€â”€ /ws  â†’ Backend WebSocket
  â”‚     â””â”€â”€ /    â†’ Frontend
  â”œâ”€â”€ Backend (Docker å®¹å™¨)
  â”œâ”€â”€ Frontend (Docker å®¹å™¨)
  â””â”€â”€ PostgreSQL (Docker å®¹å™¨ + æ•°æ®å·)

[ç”¨æˆ·æœ¬åœ°ç”µè„‘ - N å°]
  â””â”€â”€ ACP Proxy (åŸç”Ÿç¨‹åº / Docker)
        â””â”€â”€ è¿æ¥åˆ°äº‘æœåŠ¡å™¨ WebSocket
```

### 5.3 æœªæ¥æ‰©å±•ï¼ˆKubernetesï¼‰

```
[K8s Cluster]
  â”œâ”€â”€ Deployment: backend (3 replicas)
  â”œâ”€â”€ Deployment: frontend (2 replicas)
  â”œâ”€â”€ StatefulSet: postgres (1 replica + PV)
  â”œâ”€â”€ Service: backend-api (ClusterIP)
  â”œâ”€â”€ Service: backend-ws (NodePort)
  â””â”€â”€ Ingress: ç»Ÿä¸€å…¥å£
```

---

## 6. å®‰å…¨è€ƒè™‘

### 6.1 è®¤è¯ä¸æˆæƒ

**MVP é˜¶æ®µï¼ˆç®€åŒ–ï¼‰**:

- å‰ç«¯æ— éœ€ç™»å½•ï¼ˆä¿¡ä»»å†…ç½‘ï¼‰
- Agent è¿æ¥ä½¿ç”¨å›ºå®š Token

**æœªæ¥å¢å¼º**:

- å‰ç«¯ï¼šJWT Token + OAuth
- Agentï¼šåŠ¨æ€ Token + è¯ä¹¦

### 6.2 ç½‘ç»œéš”ç¦»

**Proxy â†’ Orchestrator**:

- ä½¿ç”¨ TLS/WSS (WebSocket Secure)
- éªŒè¯æœåŠ¡å™¨è¯ä¹¦

**Orchestrator â†’ GitLab**:

- Personal Access Token å­˜å‚¨åœ¨ç¯å¢ƒå˜é‡
- ä¸å†™å…¥ä»£ç æˆ–é…ç½®æ–‡ä»¶

### 6.3 æ•°æ®å®‰å…¨

**æ•æ„Ÿæ•°æ®**:

- GitLab Token: åŠ å¯†å­˜å‚¨ï¼ˆAES-256ï¼‰
- Webhook Secret: å­˜å‚¨åœ¨ç¯å¢ƒå˜é‡

**æ—¥å¿—è„±æ•**:

- ä¸è®°å½• Token æ˜æ–‡
- ä¸è®°å½•ç”¨æˆ·å¯†ç 

---

## 7. ç›‘æ§ä¸æ—¥å¿—

### 7.1 æ—¥å¿—çº§åˆ«

```
ERROR   - ç³»ç»Ÿé”™è¯¯ï¼ˆéœ€è¦ç«‹å³å¤„ç†ï¼‰
WARN    - è­¦å‘Šï¼ˆå¦‚ Agent ç¦»çº¿ã€CI å¤±è´¥ï¼‰
INFO    - é‡è¦äº‹ä»¶ï¼ˆå¦‚ä»»åŠ¡åˆ›å»ºã€PR åˆ›å»ºï¼‰
DEBUG   - è°ƒè¯•ä¿¡æ¯ï¼ˆå¦‚ WebSocket æ¶ˆæ¯è¯¦æƒ…ï¼‰
```

### 7.2 æ—¥å¿—æ ¼å¼ï¼ˆç»“æ„åŒ– JSONï¼‰

```json
{
  "timestamp": "2026-01-25T10:30:00Z",
  "level": "INFO",
  "component": "Scheduler",
  "message": "Task assigned to agent",
  "metadata": {
    "run_id": "run-123",
    "agent_id": "codex-local-1"
  }
}
```

### 7.3 å…³é”®æŒ‡æ ‡ï¼ˆæœªæ¥ Grafana Dashboardï¼‰

- ä»»åŠ¡æˆåŠŸç‡ï¼ˆSuccess Rateï¼‰
- å¹³å‡æ‰§è¡Œæ—¶é—´ï¼ˆAvg Execution Timeï¼‰
- Agent åœ¨çº¿æ•°é‡ï¼ˆOnline Agentsï¼‰
- ç³»ç»Ÿ QPSï¼ˆRequests Per Secondï¼‰
- WebSocket è¿æ¥æ•°ï¼ˆActive Connectionsï¼‰

---

## ä¸‹ä¸€æ­¥

é˜…è¯» **02_ENVIRONMENT_SETUP.md** å¼€å§‹ç¯å¢ƒå‡†å¤‡ã€‚
