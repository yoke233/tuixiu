---
title: "后台配置分层 + 外部 Issue 导入 + Agent 角色模板（GitHub/GitLab）PRD"
owner: "@tuixiu-maintainers"
status: "archived"
result: "done"
last_reviewed: "2026-01-27"
superseded_by: "docs/00_overview/roadmap.md"
---

# 后台配置分层 + 外部 Issue 导入 + Agent 角色模板（GitHub/GitLab）PRD（已归档）

> ⚠️ **已归档 / 已过期**：本文件仅用于历史追溯，可能与当前实现不一致，请勿作为开发依据。  
> 当前请以 `README.md`、`docs/00_overview/roadmap.md`、`docs/03_guides/quick-start.md` 为准。

> 说明：本文是产品 PRD（需求规格），用于指导后续实现与排期。实现计划另立 `docs/archive/plans/*-implementation.md`（如需要）。

### 1. Executive Summary

- **Problem Statement**：当前 GitHub/GitLab 已接入，但配置与凭据管理偏“工程级/散落”，难以支持多项目隔离；创建任务（Issue）无法复用外部已存在 Issue；Agent 执行缺少“角色化”（前端/后端/测试等）的默认提示词与参数管理。
- **Proposed Solution**：在后台增加“配置与凭据”能力（默认全局 + 项目覆盖），支持从 GitHub 拉取并导入/绑定外部 Issue（MVP 先 GitHub）；引入 Role Templates（角色模板）用于管理默认提示词与初始化（MVP 先 `promptTemplate + initScript`），并在发起 Run 时固化解析后的配置快照；后续引入 **Engine Profiles（执行引擎档案）** 管理不同 Agent CLI/运行参数/skills 预设，RoleTemplate 仅负责“任务语境与项目资产初始化”。
- **Success Criteria**（可量化）：
  - 项目级配置隔离：至少 2 个项目可配置不同 provider/token/默认分支且互不影响。
  - Issue 导入：可在 UI 中分页检索外部 Issue（默认每页 50），导入/绑定成功率 ≥ 99%，重复导入不产生重复数据（幂等）。
  - Run 固化快照：新建 Run 时必须固化本次执行的关键上下文（至少包含 `roleKey`、`workspacePath/branchName` 与 init 执行结果/日志事件；不得包含 token 明文），后续修改配置不影响历史 Run 的可追溯性。
  - 安全：token 不明文回显；配置变更可追溯（MVP 可先落 Events，具备用户体系后再补 `AuditLog`）。
  - Role 初始化：选择角色后，初始化脚本/配置文件可在启动 Run 前完成落盘；失败时 Run 必须可诊断（错误码 + 日志）。

### 2. User Experience & Functionality

- **User Personas**
  - 平台管理员：维护全局默认、引擎档案（可选）、全局凭据/策略与审计。
  - 项目管理员：维护项目配置、项目凭据（或 repo 凭据）、角色模板与默认策略。
  - 研发成员：从外部导入 Issue、选择角色发起 Run、查看执行与 PR/MR 结果。

- **User Stories**
  - 作为平台管理员，我想设置全局默认 provider 与安全策略，以便新项目开箱即用并可控。
  - 作为项目管理员，我想为项目配置 GitHub/GitLab 凭据与默认分支，以便不同项目使用不同权限边界。
  - 作为研发成员，我想直接从 GitHub/GitLab 拉取已有 Issue 并导入为内部 Issue，以便复用现有需求池。
  - 作为研发成员，我想在发起 Run 时选择“角色模板”（如后端开发/前端开发），以便默认提示词与参数匹配任务类型。
  - 作为项目管理员，我想为不同项目/角色设置不同的默认 Agent CLI 与运行参数（并发、sandbox、skills 预设等），以便兼容不同团队与执行环境。
  - 作为审计人员/管理员，我想查看配置变更记录与 Run 的最终解析配置，以便追责与复盘。

- **Acceptance Criteria**
  - 后台可创建/编辑项目的 SCM 配置（provider、默认分支、token/credential 引用），保存后立即生效。
  - UI 提供“导入 Issue”入口：选择项目 → 选择 provider → 输入关键字/状态筛选 → 展示列表 → 一键导入。
  - 导入后内部 Issue 必须保存外部链接信息（provider、external id/number/url），并保证幂等去重。
  - 角色模板支持“初始化能力”，用于在 Run 启动前准备环境：
    - 支持为角色配置 `initScript`（bash 脚本），系统在启动 Run 前执行；执行日志可在 Run 详情查看。
    - `initScript` 的目标是“拉取/生成/落盘”所需配置（例如从 GitHub 拉取配置仓库、下载模板、生成配置文件）。
    - `initScript` 允许写入：Run 的 workspace 目录，以及 `$HOME`（用于写入 agent 运行时的 home 配置/缓存；是否跨 Run 持久化取决于运行环境与挂载策略）。
    - 系统必须保证每个 Run 使用**独立 workspace 目录**（建议 `run-<worktreeName>`），并以该目录作为 `cwd` 执行 `initScript` 与后续 agent 任务，避免不同项目/不同 Run 互相污染。
    - 系统必须向 `initScript` 注入用于隔离/命名空间的环境变量（至少）：`TUIXIU_PROJECT_ID`、`TUIXIU_RUN_ID`、`TUIXIU_WORKSPACE`、`TUIXIU_PROJECT_HOME_DIR`；脚本应优先将可复用缓存写入 `$HOME/$TUIXIU_PROJECT_HOME_DIR`（如 `$HOME/.tuixiu/projects/<projectId>`）。
  - 发起 Run 时：
    - 默认使用项目的 `default_role_key`（可由用户覆盖）。
    - 解析出的角色与工作区信息必须被持久化（例如 `Run.metadata.roleKey`、`Run.workspacePath/branchName`、init 日志事件）；敏感信息（token）不得落库。
  - Token 字段在 UI 中只显示指纹/尾号（不可回显明文），创建/更新时才可输入明文。

- **Non-Goals**
  - MVP 不做外部 Issue 状态/评论的双向同步（只做导入/绑定与手动刷新可选）。
  - MVP 不做复杂审批流（多级 Review、自动合并策略编排）。
  - MVP 不做自动“能力画像学习”（先手动配置/标签）。
  - MVP 不支持多解释器：`initScript` 先只支持 `bash`。
  - MVP 不提供“Role Assets 后台托管/上传/版本管理”，配置文件由 `initScript` 自行拉取/生成。

### 3. AI System Requirements (If Applicable)

- **Tool Requirements**
  - GitHub REST API（Issues 列表/详情；PR 已有，MVP 先 GitHub）
  - GitLab REST API（Issues 列表/详情；MR 已有，v1.1 再补齐）
  - ACP（`execute_task` / `prompt_run`）用于把最终 prompt 下发到 Agent
  - 角色模板能力：prompt template 变量渲染（如 `{{project.name}}`、`{{repoUrl}}`、`{{branch}}`、`{{issue.title}}` 等）
  - 角色初始化：`bash` 脚本执行器（建议 proxy/agent 运行在 WSL2/Linux 或提供可用的 bash 环境）

- **Evaluation Strategy**
  - 端到端：导入 Issue → 发起 Run → 产出 PR/MR 的成功率、平均耗时（P50/P95）
  - Prompt 质量：抽样 20 个真实 Issue，比较不同角色模板下的产出质量（可用 code review 通过率/返工次数）
  - 回归：配置变更后新 Run 的解析快照与调度行为符合预期，历史 Run 不受影响

### 4. Technical Specifications

- **Architecture Overview**
  - 现有：`backend`（Orchestrator + DB）/ `acp-proxy`（WS↔ACP）/ `frontend`（后台 UI）。
  - 新增能力建议分层：
    - 配置与凭据：全局默认（system）+ 项目覆盖（project）；MVP 以“单项目=单仓库”为前提，不新增 `Repo` 实体。
    - 角色模板：独立实体，项目可设置默认角色；Run 启动时把角色模板解析进最终 prompt 与参数，并触发角色初始化（脚本/文件）。
    - 执行引擎档案（Engine Profiles，v1.1+）：用于把“Agent CLI 运行配置”从 `acp-proxy/config.json` 中抽象出来，支持后台管理与项目覆盖；RoleTemplate 可引用 profileKey（或由 Project 选择默认），从而实现不同角色/项目使用不同 agent CLI（例如 Codex/Claude）与运行参数（并发、sandbox、skills 预设等）。
    - 外部 Issue：内部 Issue 增加外部引用字段（或新表关联），用于去重与追踪。
    - 角色初始化（Role Bootstrap）：系统在 `Run.start` 前执行 `initScript`，让 agent 在进入 ACP 执行前就拥有“已准备好的工作区/配置”（例如 `.env`、`.npmrc`、代码生成配置等）。

- **Integration Points**
  - GitHub：`GET /repos/{owner}/{repo}/issues`、`GET /repos/{owner}/{repo}/issues/{number}`（仅拉取，不修改）
  - GitLab：`GET /projects/:id/issues`、`GET /projects/:id/issues/:iid`（仅拉取，不修改）
  - 数据库：新增 `RoleTemplate`（含 initScript 等初始化配置）与 Issue 外部引用字段/表；`Credential/AuditLog` 可在 v1.1 结合权限体系再引入（MVP 可先复用 `Project.*AccessToken` 字段）
  - 后端 API：
    - 列外部 issues（分页、筛选）
    - 导入外部 issue（幂等）
    - 角色模板 CRUD
    - 项目默认角色/策略更新
  - acp-proxy：接收 Run 启动指令时，按“解析后的角色配置”执行初始化步骤（脚本/落盘），再开始 ACP session/prompt（实现方式 TBD：扩展 WS payload 或通过现有 prompt 机制触发）。

- **Security & Privacy**
  - Token 存储：至少做“密文存储 + 脱敏展示”（具体加密方案 TBD：KMS/本地对称加密/数据库加密字段）。
  - 最小权限：文档提示 GitHub/GitLab token scopes；后端返回明确错误码（scope 不足/无效 token/限流）。
  - 审计：记录关键变更（凭据/角色模板/项目配置）与 Run 解析快照。
  - 脚本安全：
    - 仅允许 Admin/Project Admin 编辑 `initScript`；必须写入审计日志。
    - `initScript` 必须有超时（如 60~300s 可配）与输出采集；失败输出需脱敏（避免 token 泄漏）。
    - 允许写入 `$HOME`：需要在项目策略中显式开启（默认建议仅 workspace，以降低宿主污染与越权风险）。

### 5. Risks & Roadmap

- **Phased Rollout**
  - MVP（优先落地、改动最小）
    - 项目级配置补齐：provider、默认分支、token（MVP 先 GitHub）
    - 外部 Issue 导入（snapshot）：仅导入 title/body/url/labels；幂等去重
    - Role Templates：支持 backend-dev / frontend-dev 两个模板 + 项目默认角色 + 角色初始化（initScript）
    - Run 解析快照：写入并在 UI 展示（只读）
    - 审计日志：最小可用（记录关键对象变更）
  - v1.1（增强）
    - Engine Profiles（执行引擎档案）：把 `agent_command`、默认 env、skills 预设、sandbox provider 等从 proxy 配置提升为“后台可管理”对象；Project 选择默认 profile，RoleTemplate 可选覆盖/引用。
    - 增加 repo 级配置（当一个 Project 需要绑定多个 repo 时再做）
    - 外部 Issue 手动刷新（linked 的最小形态）
    - token 有效性校验（保存时调用 API 验证 + scopes 提示）
    - GitLab Issue 导入补齐（如需）
  - v2.0（进阶）
    - 外部 Issue 双向同步（状态/评论）+ webhook
    - Engine Profiles：统一参数映射到不同 agent CLI/运行时
    - 更完整的 RBAC 与审计导出

- **Technical Risks**
  - Token scopes 不足/限流：需要错误码、重试与分页策略；UI 提示 token 权限要求。
  - 配置覆盖与兼容：需要固定优先级与 Run 快照，否则运行中/历史复盘会混乱。
  - 需求过大：必须分期，否则容易拖慢主流程（Issue → Run → PR/MR）。

- **Open Questions（需要你确认）**
  - `initScript` 允许访问项目 GitHub token（例如通过 `GH_TOKEN`）以拉取私有配置仓库；建议文档给出最小权限 token（只读 config repo）的推荐与 scopes 提示。
  - Agent 实例是否允许“跨项目复用”？建议 MVP 先按 `projectId` 做粘性分配（一个 agent 在释放前只服务一个项目），降低缓存污染与权限误用风险；如需跨项目复用，必须强制使用 `$HOME/$TUIXIU_PROJECT_HOME_DIR` 命名空间并对 workspace 做 per-run 隔离。
  - `$HOME` 是否采用“复用 agent 实例的持久 home”（更省网络/更快）？若启用，建议脚本将缓存/配置写入 `$HOME/.tuixiu/projects/<projectId>` 等命名空间目录，并配套清理/配额策略（防止无限增长）。
  - Engine Profiles 的管理边界：默认仅平台管理员可创建/编辑？项目管理员是否可在项目作用域内覆盖 `agent_command`/env（存在更高风险）？是否需要为 profile 提供 allowlist（例如只允许选择预置的 agent CLI，而非任意命令）？
