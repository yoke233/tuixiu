generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum IssueStatus {
  pending
  running
  reviewing
  done
  failed
  cancelled
}

enum AgentType {
  local
  remote
}

enum AgentStatus {
  online
  offline
  degraded
  suspended
}

enum UserRole {
  admin
  pm
  reviewer
  dev
}

enum ExecutorType {
  agent
  ci
  human
  system
}

enum RunStatus {
  pending
  running
  waiting_ci
  completed
  failed
  cancelled
}

enum TaskStatus {
  pending
  running
  blocked
  completed
  failed
  cancelled
}

enum StepStatus {
  pending
  ready
  running
  waiting_ci
  waiting_human
  blocked
  completed
  failed
  cancelled
}

enum EventSource {
  acp
  gitlab
  system
  user
}

enum ArtifactType {
  branch
  pr
  patch
  report
  ci_result
}

model Project {
  id                     String   @id @default(uuid()) @db.Uuid
  name                   String   @db.VarChar(255)
  repoUrl                String   @db.VarChar(500)
  scmType                String   @default("gitlab") @db.VarChar(20)
  defaultBranch          String   @default("main") @db.VarChar(100)
  workspaceMode          String   @default("worktree") @db.VarChar(20)
  gitAuthMode            String   @default("https_pat") @db.VarChar(20)
  defaultRoleKey         String?  @db.VarChar(100)
  gitlabProjectId        Int?     @unique
  gitlabAccessToken      String?  @db.Text
  gitlabWebhookSecret    String?  @db.VarChar(255)
  githubAccessToken      String?  @db.Text
  branchProtection       Json?
  agentAllocationStrategy String? @db.VarChar(20)
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  issues Issue[]
  roles RoleTemplate[]

  @@index([gitlabProjectId])
}

model Issue {
  id                 String      @id @default(uuid()) @db.Uuid
  projectId          String      @db.Uuid
  project            Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)

  title              String      @db.VarChar(255)
  description        String?
  acceptanceCriteria Json?
  constraints        Json?
  testRequirements   String?     @db.Text
  status             IssueStatus @default(pending)

  externalProvider   String?     @db.VarChar(20)
  externalId         String?     @db.VarChar(100)
  externalNumber     Int?
  externalUrl        String?     @db.VarChar(500)
  externalState      String?     @db.VarChar(20)
  externalLabels     Json?
  lastSyncedAt       DateTime?

  assignedAgentId    String?     @db.Uuid
  assignedAgent      Agent?      @relation(fields: [assignedAgentId], references: [id])

  createdBy          String?     @db.VarChar(100)
  labels             Json?
  priority           Int         @default(0)

  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt
  archivedAt         DateTime?

  runs               Run[]
  tasks              Task[]

  @@index([projectId, status])
  @@index([assignedAgentId])
  @@index([status])
  @@unique([projectId, externalProvider, externalId])
}

model Agent {
  id                String      @id @default(uuid()) @db.Uuid
  name              String      @db.VarChar(255)
  type              AgentType   @default(local)

  proxyId            String      @unique @db.VarChar(100)
  gatewayId          String?     @db.VarChar(100)

  capabilities       Json?

  status            AgentStatus @default(offline)
  currentLoad       Int         @default(0)
  maxConcurrentRuns Int         @default(2)

  lastHeartbeat     DateTime?
  healthCheckInterval Int       @default(30)
  stats             Json?

  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  runs              Run[]
  assignedIssues    Issue[]

  @@index([status, currentLoad])
  @@index([proxyId])
  @@index([lastHeartbeat])
}

model Run {
  id             String    @id @default(uuid()) @db.Uuid

  issueId        String    @db.Uuid
  issue          Issue     @relation(fields: [issueId], references: [id], onDelete: Cascade)

  agentId        String?   @db.Uuid
  agent          Agent?    @relation(fields: [agentId], references: [id])

  executorType   ExecutorType @default(agent)

  taskId         String?   @db.Uuid
  task           Task?     @relation(fields: [taskId], references: [id], onDelete: SetNull)

  stepId         String?   @db.Uuid
  step           Step?     @relation(fields: [stepId], references: [id], onDelete: SetNull)

  attempt        Int       @default(1)

  acpSessionId   String?   @db.VarChar(100)

  workspaceType  String?   @db.VarChar(20)
  workspacePath  String?   @db.VarChar(500)
  branchName     String?   @db.VarChar(200)

  status         RunStatus @default(pending)

  startedAt      DateTime  @default(now())
  completedAt    DateTime?
  durationSeconds Int?

  failureReason  String?   @db.VarChar(100)
  errorMessage   String?   @db.Text

  metadata       Json?

  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  events         Event[]
  artifacts      Artifact[]

  @@index([issueId])
  @@index([agentId, status])
  @@index([taskId, startedAt])
  @@index([stepId, startedAt])
  @@index([acpSessionId])
  @@index([status])
}

model Event {
  id        String      @id @default(uuid()) @db.Uuid

  runId     String      @db.Uuid
  run       Run         @relation(fields: [runId], references: [id], onDelete: Cascade)

  source    EventSource
  type      String      @db.VarChar(100)

  payload   Json?
  metadata  Json?

  timestamp DateTime    @default(now())

  @@index([runId, timestamp(sort: Desc)])
  @@index([type])
  @@index([source])
}

model Artifact {
  id        String       @id @default(uuid()) @db.Uuid

  runId     String       @db.Uuid
  run       Run          @relation(fields: [runId], references: [id], onDelete: Cascade)

  type      ArtifactType
  content   Json

  createdAt DateTime     @default(now())

  @@index([runId, type])
}

model RoleTemplate {
  id                 String   @id @default(uuid()) @db.Uuid
  projectId          String   @db.Uuid
  project            Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  key                String   @db.VarChar(100)
  displayName        String   @db.VarChar(255)
  description        String?  @db.Text
  promptTemplate     String?  @db.Text
  initScript         String?  @db.Text
  initTimeoutSeconds Int      @default(300)

  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@unique([projectId, key])
  @@index([projectId])
}

model User {
  id           String   @id @default(uuid()) @db.Uuid
  username     String   @unique @db.VarChar(100)
  passwordHash String   @db.VarChar(255)
  role         UserRole @default(dev)

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  tasksCreated Task[]   @relation("TaskCreatedBy")
}

model Task {
  id            String     @id @default(uuid()) @db.Uuid

  issueId        String    @db.Uuid
  issue          Issue     @relation(fields: [issueId], references: [id], onDelete: Cascade)

  templateKey    String    @db.VarChar(100)
  status         TaskStatus @default(pending)

  currentStepId  String?   @unique @db.Uuid
  currentStep    Step?     @relation("TaskCurrentStep", fields: [currentStepId], references: [id])

  workspaceType  String?   @db.VarChar(20)
  workspacePath  String?   @db.VarChar(500)
  branchName     String?   @db.VarChar(200)
  baseBranch     String?   @db.VarChar(100)

  createdByUserId String?  @db.Uuid
  createdByUser   User?    @relation("TaskCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  metadata       Json?

  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  steps          Step[]
  runs           Run[]

  @@index([issueId, status])
  @@index([status])
  @@index([createdByUserId])
}

model Step {
  id           String      @id @default(uuid()) @db.Uuid

  taskId       String      @db.Uuid
  task         Task        @relation(fields: [taskId], references: [id], onDelete: Cascade)

  key          String      @db.VarChar(100)
  kind         String      @db.VarChar(100)
  order        Int
  status       StepStatus  @default(pending)

  executorType ExecutorType @default(agent)
  roleKey      String?     @db.VarChar(100)
  params       Json?
  dependsOn    Json?

  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  runs         Run[]
  currentOfTask Task?      @relation("TaskCurrentStep")

  @@unique([taskId, key])
  @@index([taskId, order])
  @@index([taskId, status])
  @@index([status])
}
