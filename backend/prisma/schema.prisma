generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum IssueStatus {
  pending
  running
  reviewing
  done
  failed
  cancelled
}

enum AgentType {
  local
  remote
}

enum AgentStatus {
  online
  offline
  degraded
  suspended
}

enum UserRole {
  admin
  pm
  reviewer
  dev
}

enum ExecutorType {
  agent
  ci
  human
  system
}

enum RunStatus {
  pending
  running
  waiting_ci
  completed
  failed
  cancelled
}

enum TaskStatus {
  pending
  running
  blocked
  completed
  failed
  cancelled
}

enum TaskTrack {
  quick
  planning
  enterprise
}

enum SandboxStatus {
  creating
  running
  stopped
  missing
  error
}

enum ScmProvider {
  github
  gitlab
}

enum ScmPrState {
  open
  closed
  merged
}

enum ScmCiStatus {
  pending
  passed
  failed
}

enum StepStatus {
  pending
  ready
  running
  waiting_ci
  waiting_human
  blocked
  completed
  failed
  cancelled
}

enum EventSource {
  acp
  gitlab
  system
  user
}

enum ArtifactType {
  branch
  pr
  patch
  report
  ci_result
}

enum ApprovalAction {
  merge_pr
  create_pr
  publish_artifact
}

enum ApprovalStatus {
  pending
  approved
  rejected
  executing
  executed
  failed
}

enum SkillVersionPolicy {
  latest
  pinned
}

enum SkillAuditAction {
  import
  check_updates
  update
  publish_latest
  rollback_latest
  bind_change
}

model Project {
  id                     String   @id @default(uuid()) @db.Uuid
  name                   String   @db.VarChar(255)
  repoUrl                String   @db.VarChar(500)
  scmType                String   @default("gitlab") @db.VarChar(20)
  defaultBranch          String   @default("main") @db.VarChar(100)
  workspaceMode          String   @default("worktree") @db.VarChar(20)
  workspacePolicy        String?  @db.VarChar(20)
  runGitCredentialId     String?  @db.Uuid
  runGitCredential       GitCredential? @relation("ProjectRunCredential", fields: [runGitCredentialId], references: [id], onDelete: SetNull)
  scmAdminCredentialId   String?  @db.Uuid
  scmAdminCredential     GitCredential? @relation("ProjectScmAdminCredential", fields: [scmAdminCredentialId], references: [id], onDelete: SetNull)
  defaultRoleKey         String?  @db.VarChar(100)
  executionProfileId     String?  @db.Uuid
  executionProfile       ExecutionProfile? @relation(fields: [executionProfileId], references: [id], onDelete: SetNull)
  enableRuntimeSkillsMounting Boolean @default(false)
  branchProtection       Json?
  agentAllocationStrategy String? @db.VarChar(20)
  agentWorkspaceNoticeTemplate String? @db.Text
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  issues Issue[]
  roles RoleTemplate[]
  textTemplates ProjectTextTemplate[]
  skillAuditLogs SkillAuditLog[]
  gitCredentials GitCredential[]
  scmConfig ProjectScmConfig?
}

model GitCredential {
  id              String   @id @default(uuid()) @db.Uuid
  projectId       String?  @db.Uuid
  project         Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)
  scope           String   @default("project") @db.VarChar(20)

  key             String   @db.VarChar(100)
  displayName     String   @db.VarChar(255)
  purpose         String?  @db.VarChar(20)
  gitAuthMode     String   @default("https_pat") @db.VarChar(20)

  githubAccessToken String? @db.Text
  gitlabAccessToken String? @db.Text
  gitHttpUsername   String? @db.VarChar(255)
  gitHttpPassword   String? @db.Text

  gitSshCommand   String?  @db.Text
  gitSshKey       String?  @db.Text
  gitSshKeyB64    String?  @db.Text

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  runDefaultForProjects Project[] @relation("ProjectRunCredential")
  scmAdminDefaultForProjects Project[] @relation("ProjectScmAdminCredential")

  @@unique([projectId, key])
  @@index([projectId])
  @@index([scope])
}

model ProjectScmConfig {
  id                  String   @id @default(uuid()) @db.Uuid
  projectId            String   @unique @db.Uuid
  project              Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  gitlabProjectId      Int?     @unique
  gitlabWebhookSecret  String?  @db.VarChar(255)

  githubPollingEnabled Boolean  @default(false)
  githubPollingCursor  DateTime?

  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@index([gitlabProjectId])
  @@index([githubPollingEnabled])
}

model Issue {
  id                 String      @id @default(uuid()) @db.Uuid
  projectId          String      @db.Uuid
  project            Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)

  title              String      @db.VarChar(255)
  description        String?
  acceptanceCriteria Json?
  constraints        Json?
  testRequirements   String?     @db.Text
  status             IssueStatus @default(pending)

  externalProvider   String?     @db.VarChar(20)
  externalId         String?     @db.VarChar(100)
  externalNumber     Int?
  externalUrl        String?     @db.VarChar(500)
  externalState      String?     @db.VarChar(20)
  externalLabels     Json?
  lastSyncedAt       DateTime?

  assignedAgentId    String?     @db.Uuid
  assignedAgent      Agent?      @relation(fields: [assignedAgentId], references: [id])

  createdBy          String?     @db.VarChar(100)
  labels             Json?
  priority           Int         @default(0)

  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt
  archivedAt         DateTime?

  runs               Run[]
  tasks              Task[]

  @@index([projectId, status])
  @@index([assignedAgentId])
  @@index([status])
  @@unique([projectId, externalProvider, externalId])
}

model Agent {
  id                String      @id @default(uuid()) @db.Uuid
  name              String      @db.VarChar(255)
  type              AgentType   @default(local)

  proxyId            String      @unique @db.VarChar(100)
  gatewayId          String?     @db.VarChar(100)

  capabilities       Json?

  status            AgentStatus @default(offline)
  currentLoad       Int         @default(0)
  maxConcurrentRuns Int         @default(2)

  lastHeartbeat     DateTime?
  healthCheckInterval Int       @default(30)
  stats             Json?

  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  runs              Run[]
  assignedIssues    Issue[]

  @@index([status, currentLoad])
  @@index([proxyId])
  @@index([lastHeartbeat])
}

model Run {
  id             String    @id @default(uuid()) @db.Uuid

  issueId        String    @db.Uuid
  issue          Issue     @relation(fields: [issueId], references: [id], onDelete: Cascade)

  agentId        String?   @db.Uuid
  agent          Agent?    @relation(fields: [agentId], references: [id])

  executorType   ExecutorType @default(agent)

  taskId         String?   @db.Uuid
  task           Task?     @relation(fields: [taskId], references: [id], onDelete: SetNull)

  stepId         String?   @db.Uuid
  step           Step?     @relation(fields: [stepId], references: [id], onDelete: SetNull)

  attempt        Int       @default(1)

  acpSessionId   String?   @db.VarChar(100)

  workspaceType  String?   @db.VarChar(20)
  workspacePath  String?   @db.VarChar(500)
  branchName     String?   @db.VarChar(200)
  resolvedWorkspacePolicy String? @db.VarChar(20)
  workspacePolicySource   Json?
  bundleSource   Json?

  executionProfileId String? @db.Uuid
  executionProfile   ExecutionProfile? @relation(fields: [executionProfileId], references: [id], onDelete: SetNull)
  executionProfileSnapshot Json?

  sandboxInstanceName String? @db.VarChar(200)
  keepaliveTtlSeconds Int?
  sandboxStatus       SandboxStatus?
  sandboxLastSeenAt   DateTime?
  sandboxLastError    String? @db.Text

  scmProvider   ScmProvider?
  scmHeadSha    String? @db.VarChar(64)
  scmPrNumber   Int?
  scmPrUrl      String? @db.VarChar(500)
  scmPrState    ScmPrState?
  scmCiStatus   ScmCiStatus?
  scmUpdatedAt  DateTime?

  status         RunStatus @default(pending)

  startedAt      DateTime  @default(now())
  completedAt    DateTime?
  durationSeconds Int?

  failureReason  String?   @db.VarChar(100)
  errorMessage   String?   @db.Text

  metadata       Json?

  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  events         Event[]
  artifacts      Artifact[]
  approvals      Approval[]
  sandboxInstances SandboxInstance[]

  @@index([issueId])
  @@index([agentId, status])
  @@index([taskId, startedAt])
  @@index([stepId, startedAt])
  @@index([acpSessionId])
  @@index([status])
  @@index([scmProvider, scmPrNumber])
  @@index([scmHeadSha])
  @@index([scmCiStatus])
}

model SandboxInstance {
  id           String   @id @default(uuid()) @db.Uuid
  proxyId      String   @db.VarChar(100)
  instanceName String   @db.VarChar(200)

  runId        String?  @db.Uuid
  run          Run?     @relation(fields: [runId], references: [id], onDelete: SetNull)

  provider     String?  @db.VarChar(50)
  runtime      String?  @db.VarChar(50)
  status       SandboxStatus?
  createdAt    DateTime?
  lastSeenAt   DateTime @default(now())
  lastError    String?  @db.Text
  deletedAt    DateTime?
  orphanedAt   DateTime?

  @@unique([proxyId, instanceName])
  @@index([proxyId])
  @@index([runId])
  @@index([status])
  @@index([lastSeenAt])
}

model Event {
  id        String      @id @default(uuid()) @db.Uuid

  runId     String      @db.Uuid
  run       Run         @relation(fields: [runId], references: [id], onDelete: Cascade)

  source    EventSource
  type      String      @db.VarChar(100)

  payload   Json?
  metadata  Json?

  timestamp DateTime    @default(now())

  @@index([runId, timestamp(sort: Desc)])
  @@index([type])
  @@index([source])
}

model Artifact {
  id        String       @id @default(uuid()) @db.Uuid

  runId     String       @db.Uuid
  run       Run          @relation(fields: [runId], references: [id], onDelete: Cascade)

  type      ArtifactType
  content   Json

  createdAt DateTime     @default(now())

  @@index([runId, type])
}

model Approval {
  id          String         @id @default(uuid()) @db.Uuid

  runId       String         @db.Uuid
  run         Run            @relation(fields: [runId], references: [id], onDelete: Cascade)

  action      ApprovalAction
  status      ApprovalStatus @default(pending)

  requestedBy String?        @db.VarChar(100)
  requestedAt DateTime       @default(now())

  decidedBy   String?        @db.VarChar(100)
  decidedAt   DateTime?

  reason      String?        @db.Text
  payload     Json?
  result      Json?

  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  @@index([runId, createdAt(sort: Desc)])
  @@index([action, status])
  @@index([status, createdAt(sort: Desc)])
}

model RoleTemplate {
  id                 String   @id @default(uuid()) @db.Uuid
  projectId          String?  @db.Uuid
  project            Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)
  scope              String   @default("project") @db.VarChar(20)

  key                String   @db.VarChar(100)
  displayName        String   @db.VarChar(255)
  description        String?  @db.Text
  promptTemplate     String?  @db.Text
  initScript         String?  @db.Text
  initTimeoutSeconds Int      @default(300)
  envText            String?  @db.Text
  agentInputs        Json?
  workspacePolicy    String?  @db.VarChar(20)
  executionProfileId String?  @db.Uuid
  executionProfile   ExecutionProfile? @relation(fields: [executionProfileId], references: [id], onDelete: SetNull)

  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  skillBindings      RoleSkillBinding[]
  skillAuditLogs     SkillAuditLog[]

  @@unique([projectId, key])
  @@index([projectId])
  @@index([scope])
}

model ExecutionProfile {
  id                 String   @id @default(uuid()) @db.Uuid
  key                String   @unique @db.VarChar(100)
  displayName        String?  @db.VarChar(255)
  description        String?  @db.Text
  workspacePolicy    String?  @db.VarChar(20)
  skillsPolicy       String?  @db.VarChar(20)
  toolPolicy         Json?
  dataPolicy         Json?

  createdByUserId    String?  @db.Uuid
  createdByUser      User?    @relation("ExecutionProfileCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)
  updatedByUserId    String?  @db.Uuid
  updatedByUser      User?    @relation("ExecutionProfileUpdatedBy", fields: [updatedByUserId], references: [id], onDelete: SetNull)

  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  roles              RoleTemplate[]
  projects           Project[]
  runs               Run[]
  tasks              Task[]
  auditLogs          ExecutionProfileAuditLog[]

  @@index([createdAt])
}

model ExecutionProfileAuditLog {
  id                 String   @id @default(uuid()) @db.Uuid
  executionProfileId String   @db.Uuid
  executionProfile   ExecutionProfile @relation(fields: [executionProfileId], references: [id], onDelete: Cascade)

  action             String   @db.VarChar(50)
  actorUserId        String?  @db.Uuid
  actorUser          User?    @relation("ExecutionProfileAuditActor", fields: [actorUserId], references: [id], onDelete: SetNull)
  payload            Json?

  createdAt          DateTime @default(now())

  @@index([executionProfileId, createdAt(sort: Desc)])
  @@index([action, createdAt(sort: Desc)])
}

model Skill {
  id          String   @id @default(uuid()) @db.Uuid
  name        String   @unique @db.VarChar(200)
  description String?  @db.Text
  tags        String[]

  sourceType       String? @db.VarChar(50)
  sourceKey        String? @db.VarChar(300)
  latestVersionId  String? @db.Uuid
  latestVersion    SkillVersion? @relation("SkillLatestVersion", fields: [latestVersionId], references: [id], onDelete: SetNull)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  versions    SkillVersion[]
  roleBindings RoleSkillBinding[]
  auditLogs   SkillAuditLog[]

  @@unique([sourceType, sourceKey])
  @@index([updatedAt])
  @@index([latestVersionId])
}

model SkillVersion {
  id          String   @id @default(uuid()) @db.Uuid
  skillId     String   @db.Uuid
  skill       Skill    @relation(fields: [skillId], references: [id], onDelete: Cascade)

  contentHash String   @db.VarChar(128)
  storageUri  String?  @db.VarChar(500)
  source      Json?
  sourceRevision String? @db.VarChar(100)
  packageSize Int?
  manifestJson Json?

  importedAt  DateTime @default(now())

  roleBindings RoleSkillBinding[]
  latestForSkills Skill[] @relation("SkillLatestVersion")
  auditLogs   SkillAuditLog[]

  @@unique([skillId, contentHash])
  @@index([skillId, importedAt(sort: Desc)])
}

model RoleSkillBinding {
  id              String            @id @default(uuid()) @db.Uuid

  roleTemplateId  String            @db.Uuid
  roleTemplate    RoleTemplate      @relation(fields: [roleTemplateId], references: [id], onDelete: Cascade)

  skillId         String            @db.Uuid
  skill           Skill             @relation(fields: [skillId], references: [id], onDelete: Cascade)

  versionPolicy   SkillVersionPolicy @default(latest)
  pinnedVersionId String?           @db.Uuid
  pinnedVersion   SkillVersion?     @relation(fields: [pinnedVersionId], references: [id], onDelete: SetNull)

  enabled         Boolean           @default(true)

  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@unique([roleTemplateId, skillId])
  @@index([roleTemplateId])
  @@index([skillId])
  @@index([pinnedVersionId])
}

model SkillAuditLog {
  id             String          @id @default(uuid()) @db.Uuid
  action         SkillAuditAction

  actorUserId    String?         @db.Uuid
  actorUsername  String?         @db.VarChar(100)

  skillId        String?         @db.Uuid
  skill          Skill?          @relation(fields: [skillId], references: [id], onDelete: SetNull)

  skillVersionId String?         @db.Uuid
  skillVersion   SkillVersion?   @relation(fields: [skillVersionId], references: [id], onDelete: SetNull)

  projectId      String?         @db.Uuid
  project        Project?        @relation(fields: [projectId], references: [id], onDelete: SetNull)

  roleTemplateId String?         @db.Uuid
  roleTemplate   RoleTemplate?   @relation(fields: [roleTemplateId], references: [id], onDelete: SetNull)

  sourceType     String?         @db.VarChar(50)
  sourceKey      String?         @db.VarChar(300)
  sourceRevision String?         @db.VarChar(100)

  fromVersionId  String?         @db.Uuid
  toVersionId    String?         @db.Uuid

  payload        Json?
  createdAt      DateTime        @default(now())

  @@index([createdAt(sort: Desc)])
  @@index([action, createdAt(sort: Desc)])
  @@index([skillId, createdAt(sort: Desc)])
  @@index([projectId, roleTemplateId, createdAt(sort: Desc)])
  @@index([sourceType, sourceKey])
}

model PlatformTextTemplate {
  key         String   @id @db.VarChar(200)
  template    String   @db.Text
  description String?  @db.Text

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model ProjectTextTemplate {
  id        String   @id @default(uuid()) @db.Uuid
  projectId String   @db.Uuid
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  key       String   @db.VarChar(200)
  template  String   @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([projectId, key])
  @@index([projectId])
}

model User {
  id           String   @id @default(uuid()) @db.Uuid
  username     String   @unique @db.VarChar(100)
  passwordHash String   @db.VarChar(255)
  role         UserRole @default(dev)

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  tasksCreated Task[]   @relation("TaskCreatedBy")
  executionProfilesCreated ExecutionProfile[] @relation("ExecutionProfileCreatedBy")
  executionProfilesUpdated ExecutionProfile[] @relation("ExecutionProfileUpdatedBy")
  executionProfileAuditLogs ExecutionProfileAuditLog[] @relation("ExecutionProfileAuditActor")
  refreshSessions RefreshSession[]
}

model RefreshSession {
  id            String   @id @default(uuid()) @db.Uuid
  userId        String   @db.Uuid
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  tokenHash     String   @unique @db.VarChar(128)
  rotatedFromId String?  @unique @db.Uuid
  rotatedFrom   RefreshSession? @relation("RefreshRotation", fields: [rotatedFromId], references: [id], onDelete: SetNull)
  rotatedTo     RefreshSession? @relation("RefreshRotation")

  createdAt     DateTime @default(now())
  lastUsedAt    DateTime?
  expiresAt     DateTime
  revokedAt     DateTime?

  ip            String?  @db.VarChar(64)
  userAgent     String?  @db.Text

  @@index([userId, createdAt(sort: Desc)])
  @@index([userId, revokedAt])
  @@index([expiresAt])
}

model Task {
  id            String     @id @default(uuid()) @db.Uuid

  issueId        String    @db.Uuid
  issue          Issue     @relation(fields: [issueId], references: [id], onDelete: Cascade)

  templateKey    String    @db.VarChar(100)
  track          TaskTrack?
  status         TaskStatus @default(pending)

  currentStepId  String?   @unique @db.Uuid
  currentStep    Step?     @relation("TaskCurrentStep", fields: [currentStepId], references: [id])

  workspaceType  String?   @db.VarChar(20)
  workspacePath  String?   @db.VarChar(500)
  branchName     String?   @db.VarChar(200)
  baseBranch     String?   @db.VarChar(100)
  workspacePolicy String?  @db.VarChar(20)
  resolvedWorkspacePolicy String? @db.VarChar(20)
  workspacePolicySource   Json?
  bundleSource    Json?

  executionProfileId String? @db.Uuid
  executionProfile   ExecutionProfile? @relation(fields: [executionProfileId], references: [id], onDelete: SetNull)
  executionProfileSnapshot Json?

  createdByUserId String?  @db.Uuid
  createdByUser   User?    @relation("TaskCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  metadata       Json?

  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  steps          Step[]
  runs           Run[]

  @@index([issueId, status])
  @@index([status])
  @@index([createdByUserId])
}

model Step {
  id           String      @id @default(uuid()) @db.Uuid

  taskId       String      @db.Uuid
  task         Task        @relation(fields: [taskId], references: [id], onDelete: Cascade)

  key          String      @db.VarChar(100)
  kind         String      @db.VarChar(100)
  order        Int
  status       StepStatus  @default(pending)

  executorType ExecutorType @default(agent)
  roleKey      String?     @db.VarChar(100)
  params       Json?
  dependsOn    Json?

  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  runs         Run[]
  currentOfTask Task?      @relation("TaskCurrentStep")

  @@unique([taskId, key])
  @@index([taskId, order])
  @@index([taskId, status])
  @@index([status])
}
